@startuml
!pragma teoz true

skinparam sequenceMessageAlign center
skinparam BoxPadding 15
skinparam ParticipantPadding 40
skinparam SequenceBoxBorderColor #888888
skinparam SequenceGroupBorderThickness 2
skinparam SequenceGroupHeaderFontSize 12
skinparam SequenceGroupHeaderFontStyle bold
skinparam SequenceGroupBackgroundColor #F8F8F8

actor "Calling LLM" as User
participant "Orchestrator" as Orch
participant "LLM Client" as LLM
participant "Kroki" as Kroki

== Setup Phase ==

User -> Orch: execute(description, diagram_type)
activate Orch

Orch -> LLM: detect_subtype(description)
activate LLM
LLM -> LLM: Analyze description
LLM --> Orch: subtype (e.g., "collaboration")
deactivate LLM

Orch -> Orch: load_example(diagram_type, subtype)
note right: Loads reference examples\nFor BPMN collaboration: loads 2 examples

== Description Validation Phase ==

Orch -> LLM: validate_description(description)
activate LLM
LLM -> LLM: Check completeness,\nconsistency, clarity
LLM --> Orch: (is_valid, questions)
deactivate LLM

alt #LightCoral Description invalid
    Orch --> User: Return validation questions\n(exit with error)
    note right: User must refine\nand re-run
    deactivate Orch
else #LightGreen Description valid
    note right: Continue to generation
end

== Code Generation & Validation Loop ==

loop #LightBlue Iteration Loop (max 5 attempts)

    Orch -> Orch: Build prompt\n(initial or refinement)
    note right: Includes example(s),\nprevious errors/feedback

    Orch -> LLM: generate(prompt)
    activate LLM
    LLM -> LLM: Generate diagram code
    LLM --> Orch: diagram_source
    deactivate LLM

    Orch -> Kroki: render_diagram(source, "svg")
    activate Kroki
    Kroki -> Kroki: Parse & validate syntax
    Kroki --> Orch: validation_bytes or error
    deactivate Kroki

    alt #LightCoral Syntax error
        Orch -> Orch: Save error for next iteration
        note right: Loop continues
    else #LightGreen Syntax valid

        opt #LightYellow Design validation enabled

            Orch -> Kroki: render_diagram(source, "png")
            activate Kroki
            Kroki --> Orch: png_bytes or error
            deactivate Kroki

            alt #PaleGreen PNG supported
                Orch -> LLM: vision_analyze(png_bytes, criteria)
                activate LLM
                LLM -> LLM: Analyze layout,\nreadability, spacing
                LLM --> Orch: feedback
                deactivate LLM

                alt Design approved
                    Orch -> Orch: Exit loop
                    note right: Success!
                else Design needs improvement
                    Orch -> Orch: Save feedback for next iteration
                    note right: Loop continues
                end
            else #PaleTurquoise PNG not supported
                Orch -> Orch: Skip design validation,\nexit loop
                note right: Syntax valid is enough
            end
        else Design validation disabled
            Orch -> Orch: Exit loop
            note right: Syntax valid is enough
        end
    end
end

== Finalization ==

Orch -> Orch: Write output files\n(SVG, PNG, source)
Orch --> User: Return result\n(metadata, file paths)
deactivate Orch

@enduml
